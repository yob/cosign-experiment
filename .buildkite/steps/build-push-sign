#!/bin/sh 

set -e

echo "+++ fetching OIDC token from Buildkite"

# Now fetch an OIDC token from Buildkite. Audience must be "sigstore", as required by fulcio
# SIGSTORE_ID_TOKEN is a special ENV that cosign looks for. It will use the OIDC token it finds
# there to request a short term x.509 certificate from sigstore/fulcio, and then sign the
# image with it
SIGSTORE_ID_TOKEN="$(buildkite-agent oidc request-token --audience sigstore)"

echo "+++ creating signed image"

# append new data to the README to ensure the docker image busts cache and has
# a new layer
echo `date --iso-8601=seconds` > README.md

echo "${GITHUB_TOKEN}" | docker login -u "${GITHUB_USERNAME}" --password-stdin ghcr.io

IMAGE_NAME="ghcr.io/${GITHUB_USERNAME}/cosign-experiment:${BUILDKITE_BUILD_NUMBER}"

docker buildx build --metadata-file metadata.json --push -t "${IMAGE_NAME}" .

IMAGE_DIGEST=$(cat metadata.json | jq -r '."containerimage.digest"')

cosign sign --yes --output-certificate fulcio.crt "${IMAGE_NAME}@${IMAGE_DIGEST}"

echo "+++ examine the certificate"

openssl x509 -in fulcio.crt -text -noout

echo "+++ cosign triangulate"

cosign triangulate  "${IMAGE_NAME}"

echo "+++ cosign verify"

$ cosign verify "${IMAGE_NAME}" --certificate-identity https://buildkite.com/yob-opensource/cosign-experiment --certificate-oidc-issuer https://agent.buildkite.com
